<!DOCTYPE html>
<html lang="en">
  <%- include("./partials/head.ejs") %>
  <body>
    <!-- Partials is short for Partial Templates -->
    <%- include("./partials/nav.ejs") %>

    <main class="index content">
      <div>
        <form class="auth-form">
          <h2>Sign Up</h2>
          <div class="signup error"></div>
          <label for="firstname">First Name</label>
          <input id="firstname" type="text" name="firstname" required />
          <label for="lastname">last Name</label>
          <input id="lastname" type="text" name="lastname" required />
          <label for="email">Email</label>
          <input id="email" type="text" name="email" required />
          <div class="email error"></div>
          <label for="password">Password</label>
          <input id="password" type="password" name="password" required />
          <label for="confirm_password">Confirm Password</label>
          <input
          id="confirm_password"
          type="password"
          name="confirm_password"
          required
          />
          <div class="password error"></div>
          <div class="password-tips">
            <strong>Must Contain:</strong>
            <ul>
              <li>Minimum 6 characters</li>
              <li>A lowercase character</li>
              <li>An uppercase character</li>
              <li>A number character</li>
            </ul>
          </div>
          <div class="buttons">
            <button class="button-primary">Sign Up</button>
            <a class="button-secondary" href="/login">Sign In</a>
          </div>
        </form>
      </div>
    </main>

    <%- include('./partials/footer') %>

    <script>
      const signup = document.querySelector(".button-primary");
      const signupError = document.querySelector(".signup.error");
      const emailError = document.querySelector(".email.error");
      const passwordError = document.querySelector(".password.error");

      signup.addEventListener("click", (e) => {
        e.preventDefault();
        const firstname = document.querySelector("#firstname").value;
        const lastname = document.querySelector("#lastname").value;
        const email = document.querySelector("#email").value;
        const password = document.querySelector("#password").value;
        const confirm_password =
          document.querySelector("#confirm_password").value;

        // Clean up text
        signupError.textContent = "";
        emailError.textContent = "";
        passwordError.textContent = "";

        if (password === confirm_password) {
          fetch("/sign-up", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ firstname, lastname, email, password }),
          })
            .then((response) => response.json())
            .then((data) => {
              console.log(data);
              if (data.error) {
                signupError.textContent = data.error.error + "!";

                if (data.error.email) {
                  emailError.textContent = data.error.email.message;
                }

                if (data.error.email.kind === "required") {
                  emailError.textContent = "Email is required"
                }

                if (data.error.password) {
                  passwordError.textContent = data.error.password.message;
                }
                
                if (data.error.password.kind === "required") {
                  passwordError.textContent = "Password is required";
                }
              }

              if (data.message) {
                location = data.redirect;
              }
            })
            .catch((err) => console.log(err));
        } else {
          signupError.textContent = "Passwords don't match";
        }
      });
    </script>
  </body>
</html>
